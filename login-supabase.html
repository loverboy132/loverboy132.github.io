<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Craftnet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dark-mode.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden-view { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <div class="flex justify-center mb-6">
            <a href="index.html">
                <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
                    width="96" height="96" viewBox="0 0 300.000000 300.000000"
                    preserveAspectRatio="xMidYMid meet" class="h-24 w-auto"
                    fill="currentColor"
                    style="color: #1d4ed8;"
                >
                    <g transform="translate(0.000000,300.000000) scale(0.100000,-0.100000)"
                    fill="currentColor" stroke="none">
                    <path d="M539 1931 c-153 -50 -269 -212 -269 -375 0 -67 24 -156 55 -211 36
                    -60 116 -132 183 -163 50 -24 69 -27 162 -27 99 0 110 2 171 32 196 97 281
                    340 189 537 -35 74 -112 151 -187 188 -57 28 -78 33 -157 35 -68 2 -105 -2
                    -147 -16z m241 -57 c142 -46 241 -199 227 -352 -12 -124 -83 -229 -193 -283
                    -55 -28 -76 -32 -137 -32 -136 1 -250 71 -313 193 -26 49 -29 65 -29 150 0 89
                    2 99 34 158 84 155 244 220 411 166z"/>
                    <path d="M627 1822 c-22 -24 -21 -57 3 -109 33 -73 75 -47 97 58 11 54 -64 91
                    -100 51z m63 -27 c12 -15 6 -49 -13 -73 -8 -11 -13 -9 -23 10 -17 30 -17 65
                    -1 71 20 9 24 8 37 -8z"/>
                    <path d="M449 1726 c-14 -29 -2 -51 34 -62 12 -3 34 -18 49 -32 23 -21 30 -23
                    43 -12 14 12 13 16 -14 44 -16 17 -31 42 -33 56 -2 20 -9 26 -35 28 -27 3 -35
                    -1 -44 -22z"/>
                    <path d="M812 1738 c-6 -6 -12 -19 -12 -28 0 -9 -11 -27 -25 -40 -14 -13 -25
                    -29 -25 -36 0 -25 22 -26 46 -3 14 13 39 28 57 34 28 9 32 14 32 45 0 32 -3
                    35 -30 38 -17 2 -36 -3 -43 -10z"/>
                    <path d="M618 1616 c-24 -18 -39 -63 -32 -92 8 -33 50 -64 86 -64 69 0 106
                    100 55 148 -26 25 -82 29 -109 8z m80 -38 c21 -21 14 -57 -14 -70 -23 -11 -29
                    -10 -45 10 -15 19 -16 28 -7 48 12 26 46 32 66 12z"/>
                    <path d="M388 1565 c-9 -21 -8 -28 7 -45 21 -24 48 -26 65 -5 7 9 29 15 51 15
                    32 0 39 3 39 20 0 17 -7 20 -44 20 -25 0 -48 5 -51 10 -13 20 -55 11 -67 -15z"/>
                    <path d="M875 1581 c-6 -5 -28 -11 -50 -13 -57 -4 -55 -32 2 -36 23 -2 47 -10
                    53 -18 31 -36 93 12 70 55 -11 22 -58 29 -75 12z"/>
                    <path d="M536 1451 c-16 -17 -40 -31 -55 -33 -21 -2 -27 -9 -29 -35 -3 -27 1
                    -35 22 -45 22 -9 29 -8 46 7 11 10 20 25 20 34 0 8 12 27 26 42 16 17 24 34
                    21 43 -9 23 -20 20 -51 -13z"/>
                    <path d="M753 1464 c-3 -9 5 -26 21 -43 14 -15 26 -37 26 -49 0 -14 9 -27 25
                    -34 21 -9 28 -8 45 7 32 29 20 75 -20 75 -9 0 -29 14 -45 30 -32 34 -43 37
                    -52 14z"/>
                    <path d="M650 1392 c0 -23 -6 -45 -15 -52 -24 -20 -19 -59 11 -72 45 -21 79
                    19 55 66 -6 11 -12 37 -13 56 -2 24 -9 36 -20 38 -15 3 -18 -4 -18 -36z"/>
                    <path d="M1840 1728 c-29 -11 -40 -25 -40 -55 0 -14 -6 -23 -15 -23 -9 0 -15
                    -10 -15 -26 0 -19 4 -25 15 -20 13 4 15 -9 15 -84 l0 -90 30 0 30 0 0 90 0 90
                    25 -6 c22 -5 25 -3 25 20 0 21 -5 26 -25 26 -19 0 -25 5 -25 21 0 16 5 20 28
                    17 22 -2 28 1 30 20 2 13 -2 22 -10 23 -7 0 -20 2 -28 3 -8 2 -26 -1 -40 -6z"/>
                    <path d="M1223 1715 c-48 -21 -73 -68 -73 -140 0 -102 63 -166 147 -150 40 7
                    99 56 89 73 -11 19 -50 14 -69 -8 -22 -26 -50 -25 -81 3 -39 34 -39 124 -1
                    162 31 31 49 31 81 0 20 -20 29 -23 49 -15 14 5 25 13 25 18 0 14 -43 50 -73
                    61 -37 14 -55 13 -94 -4z"/>
                    <path d="M1954 1695 c-4 -8 -4 -21 -1 -29 3 -8 -2 -16 -15 -19 -23 -6 -22 -42
                    2 -42 11 0 13 -13 11 -55 -3 -68 11 -107 43 -121 36 -17 76 -4 76 24 0 18 -5
                    23 -27 22 -28 0 -28 1 -31 67 l-3 68 31 -6 c27 -6 30 -4 30 20 0 22 -4 26 -30
                    26 -27 0 -30 3 -30 30 0 25 -4 30 -25 30 -14 0 -28 -7 -31 -15z"/>
                    <path d="M2590 1681 c0 -21 -5 -31 -15 -31 -9 0 -15 -10 -15 -26 0 -19 4 -25
                    15 -20 13 4 15 -8 15 -74 0 -70 2 -81 22 -94 28 -20 62 -20 82 -1 21 22 11 41
                    -22 40 -26 0 -27 1 -30 67 l-3 68 31 -6 c27 -6 30 -4 30 20 0 22 -4 26 -31 26
                    -27 0 -30 3 -27 28 3 23 -1 27 -24 30 -25 3 -28 0 -28 -27z m36 -67 c-5 -13
                    -10 -14 -18 -6 -6 6 -8 18 -4 28 5 13 10 14 18 6 6 -6 8 -18 4 -28z"/>
                    <path d="M1420 1540 l0 -110 31 0 32 0 -6 48 c-9 74 1 102 39 118 23 9 34 21
                    34 34 0 28 -44 27 -64 -2 l-16 -22 0 22 c0 17 -6 22 -25 22 l-25 0 0 -110z"/>
                    <path d="M1592 1634 c-12 -8 -22 -21 -22 -28 0 -22 31 -28 51 -10 26 23 69 11
                    69 -19 0 -19 -6 -22 -47 -25 -53 -3 -83 -24 -83 -59 0 -60 57 -90 107 -57 19
                    12 28 13 31 6 2 -7 15 -12 28 -12 24 0 24 2 24 85 0 78 -2 88 -25 110 -29 30
                    -97 34 -133 9z m82 -161 c-27 -20 -49 -12 -49 17 0 20 6 26 30 30 24 4 31 2
                    33 -14 2 -11 -4 -26 -14 -33z"/>
                    <path d="M2110 1540 l0 -110 25 0 c24 0 25 2 25 66 0 80 11 104 49 104 36 0
                    41 -13 41 -101 0 -67 1 -69 25 -69 25 0 25 1 25 90 0 77 -3 93 -20 110 -24 24
                    -82 27 -104 4 -15 -14 -16 -14 -16 0 0 10 -9 16 -25 16 l-25 0 0 -110z"/>
                    <path d="M2366 1624 c-22 -23 -26 -36 -26 -83 0 -33 6 -65 15 -77 33 -48 122
                    -55 160 -14 28 31 6 48 -36 27 -35 -16 -57 -13 -76 11 -29 35 -16 43 59 41 47
                    -2 73 2 76 9 7 21 -19 82 -41 97 -36 25 -100 19 -131 -11z m112 -41 c3 -21 -1
                    -23 -42 -23 -50 0 -51 1 -35 31 15 29 73 23 77 -8z"/>
                    </g>
                </svg>
            </a>
        </div>
        <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Sign in to your account</h2>
        <form id="login-form" onsubmit="return false;">
            <div class="mb-4">
                <label for="email" class="block text-gray-700 font-semibold mb-2">Email Address</label>
                <input type="email" id="login-email" name="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="yourname@example.com" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-semibold mb-2">Password</label>
                <input type="password" id="login-password" name="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <p id="login-error" class="text-red-500 text-sm mb-4 hidden-view"></p>
            <button id="login-button" type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center">
                <span id="login-button-text">Sign in</span>
                <span id="login-spinner" class="hidden ml-2 h-5 w-5 border-t-2 border-r-2 border-white rounded-full animate-spin"></span>
            </button>
        </form>
        <p class="mt-6 text-center text-gray-500">
            Don't have an account?
            <a href="signup-member-supabase.html" class="text-indigo-600 hover:text-indigo-800 font-semibold">Sign up as a Member</a> or
            <a href="signup-apprentice-supabase.html" class="text-indigo-600 hover:text-indigo-800 font-semibold">Sign up as an Apprentice</a>.
        </p>
    </div>
    <script type="module">
        // Remove credentials from URL if present (security issue)
        if (window.location.search.includes('email=') || window.location.search.includes('password=')) {
            console.warn('‚ö†Ô∏è Credentials detected in URL - removing for security');
            const cleanUrl = window.location.pathname;
            window.history.replaceState({}, document.title, cleanUrl);
        }

        // Add error handling for module imports
        let handleLogin, showError;
        
        try {
            const authModule = await import('./supabase-auth.js');
            handleLogin = authModule.handleLogin;
            showError = authModule.showError;
            console.log('‚úÖ Auth module loaded successfully');
        } catch (importError) {
            console.error('‚ùå Failed to load auth module:', importError);
            const errorEl = document.getElementById('login-error');
            if (errorEl) {
                errorEl.textContent = 'Failed to load authentication module. Please refresh the page.';
                errorEl.classList.remove('hidden-view', 'hidden');
            }
            throw importError;
        }

        // Setup form handler - don't wait for DOMContentLoaded
        function setupLoginForm() {
            console.log('‚úÖ Setting up login form handler');
            
            const loginForm = document.getElementById('login-form');

            if (!loginForm) {
                console.error('‚ùå Login form not found');
                // Retry after a short delay if DOM isn't ready
                setTimeout(setupLoginForm, 100);
                return;
            }

            // Attach event listener directly (no need to clone)
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('üìù Login form submitted');
                
                // Re-get elements in case DOM changed
                const emailEl = document.getElementById('login-email');
                const passwordEl = document.getElementById('login-password');
                const loginBtn = document.getElementById('login-button');
                const btnText = document.getElementById('login-button-text');
                const spinEl = document.getElementById('login-spinner');
                
                btnText.textContent = 'Signing in...';
                spinEl.classList.remove('hidden');
                loginBtn.disabled = true;
                
                if (!emailEl || !passwordEl) {
                    console.error('‚ùå Form fields missing');
                    showError('login-error', 'Form fields are missing. Please refresh the page.');
                    btnText.textContent = 'Sign in';
                    spinEl.classList.add('hidden');
                    loginBtn.disabled = false;
                    return;
                }
                
                const email = emailEl.value.trim();
                const password = passwordEl.value;
                
                if (!email || !password) {
                    showError('login-error', 'Please enter both email and password.');
                    btnText.textContent = 'Sign in';
                    spinEl.classList.add('hidden');
                    loginBtn.disabled = false;
                    return;
                }
                
                try {
                    console.log("üîê Attempting login for:", email);
                    console.log("üìç Current URL:", window.location.href);
                    
                    await handleLogin(email, password);
                    
                    console.log("‚úÖ Login successful, redirect should happen now");
                    // Don't reset button - redirect should happen
                } catch (error) {
                    console.error("‚ùå Login failed:", error);
                    console.error("Error details:", {
                        message: error?.message,
                        code: error?.code,
                        stack: error?.stack
                    });
                    
                    // The error is already handled in handleLogin, but we need to reset the button state
                    const btnText = document.getElementById('login-button-text');
                    const spinEl = document.getElementById('login-spinner');
                    const loginBtn = document.getElementById('login-button');
                    btnText.textContent = 'Sign in';
                    spinEl.classList.add('hidden');
                    loginBtn.disabled = false;
                    
                    // Show error if not already shown
                    if (error?.message && !error.message.includes('EMAIL_NOT_VERIFIED')) {
                        showError('login-error', error.message || 'Login failed. Please try again.');
                    }
                }
            });
            
            console.log('‚úÖ Login form handler attached');
        }

        // Try to setup immediately, or wait for DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupLoginForm);
        } else {
            setupLoginForm();
        }
    </script>
    <script src="dark-mode.js"></script>
</body>
</html>